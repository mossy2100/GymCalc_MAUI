<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="GymCalc.Pages.CalculatorPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:graphics="clr-namespace:GymCalc.Graphics"
    xmlns:input="clr-namespace:InputKit.Shared.Controls;assembly=InputKit.Maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:GymCalc.Models"
    xmlns:viewModels="clr-namespace:GymCalc.ViewModels"
    xmlns:converters="clr-namespace:GymCalc.Converters"
    xmlns:drawables="clr-namespace:GymCalc.Drawables"
    x:DataType="viewModels:CalculatorViewModel"
    Title="Calculator">

    <ContentPage.Resources>
        <converters:WeightTextConverter x:Key="DefaultWeightTextConverter" />
    </ContentPage.Resources>

    <ScrollView
        x:Name="CalculatorScrollView"
        Padding="{x:Static graphics:PageLayout.Spacing}"
        VerticalOptions="Fill">
        <StackLayout x:Name="CalculatorLayout"
            Spacing="{x:Static graphics:PageLayout.DoubleSpacing}">

            <!--
            Calculator form.
            Appears on top or left-hand side of page, depending on orientation.
            -->
            <VerticalStackLayout Spacing="{x:Static graphics:PageLayout.Spacing}">
                <!--  Exercise type  -->
                <Label Text="Select exercise type:" />
                <Grid
                    x:Name="ExerciseTypeButtonGrid"
                    ColumnDefinitions="*,*"
                    ColumnSpacing="{x:Static graphics:PageLayout.Spacing}"
                    RowDefinitions="Auto,Auto"
                    RowSpacing="{x:Static graphics:PageLayout.Spacing}">
                    <Button
                        x:Name="BarbellButton"
                        Grid.Row="0" Grid.Column="0"
                        Clicked="OnBarbellButtonClicked"
                        Style="{StaticResource BarbellButtonStyle}"
                        Text="Barbell" />
                    <Button
                        x:Name="DumbbellButton"
                        Grid.Row="0" Grid.Column="1"
                        Clicked="OnDumbbellButtonClicked"
                        Style="{StaticResource DumbbellButtonStyle}"
                        Text="Dumbbell" />
                    <Button
                        x:Name="MachineButton"
                        Grid.Row="1" Grid.Column="0"
                        Clicked="OnMachineButtonClicked"
                        Style="{StaticResource MachineButtonStyle}"
                        Text="Machine" />
                    <Button
                        x:Name="KettlebellButton"
                        Grid.Row="1" Grid.Column="1"
                        Clicked="OnKettlebellButtonClicked"
                        Style="{StaticResource KettlebellButtonStyle}"
                        Text="Kettlebell" />
                </Grid>

                <!--  Max weight  -->
                <Grid
                    ColumnDefinitions="7*,2*,*"
                    ColumnSpacing="{x:Static graphics:PageLayout.Spacing}"
                    RowDefinitions="Auto">
                    <Label
                        x:Name="MaxWeightLabel"
                        Grid.Row="0" Grid.Column="0"
                        HorizontalTextAlignment="Start"
                        Text="Maximum weight"
                        VerticalTextAlignment="Center" />
                    <Frame
                        Grid.Row="0" Grid.Column="1"
                        Style="{StaticResource ControlFrameStyle}">
                        <Entry
                            HorizontalTextAlignment="End"
                            Keyboard="Numeric"
                            VerticalTextAlignment="Center"
                            Text="{Binding MaxWeightText, Mode=TwoWay}" />
                    </Frame>
                    <Label
                        Grid.Row="0" Grid.Column="2"
                        HorizontalTextAlignment="Start"
                        Text="{Binding MaxWeightUnits}"
                        VerticalTextAlignment="Center" />
                </Grid>

                <!--  Bar weight  -->
                <Grid
                    x:Name="BarWeightGrid"
                    ColumnDefinitions="7*,2*,*"
                    ColumnSpacing="{x:Static graphics:PageLayout.Spacing}"
                    RowDefinitions="Auto">
                    <Label
                        Grid.Row="0" Grid.Column="0"
                        FontSize="16"
                        HorizontalTextAlignment="Start"
                        Text="Bar weight"
                        VerticalTextAlignment="Center" />
                    <Frame
                        Grid.Row="0" Grid.Column="1"
                        Style="{StaticResource ControlFrameStyle}">
                        <Picker
                            ItemsSource="{Binding BarWeights}"
                            SelectedItem="{Binding BarWeight, Mode=TwoWay}"
                            HorizontalTextAlignment="End" VerticalTextAlignment="Center" />
                    </Frame>
                    <Label
                        Grid.Row="0" Grid.Column="2"
                        HorizontalTextAlignment="Start" VerticalTextAlignment="Center"
                        Text="{Binding BarWeightUnits}" />
                </Grid>

                <!--  Machine starting weight  -->
                <Grid
                    x:Name="StartingWeightGrid"
                    ColumnDefinitions="7*,2*,*"
                    ColumnSpacing="{x:Static graphics:PageLayout.Spacing}"
                    RowDefinitions="Auto">
                    <Label
                        Grid.Row="0" Grid.Column="0"
                        HorizontalTextAlignment="Start"
                        Text="Starting weight"
                        VerticalTextAlignment="Center" />
                    <Frame
                        Grid.Row="0" Grid.Column="1"
                        Style="{StaticResource ControlFrameStyle}">
                        <Entry
                            Text="{Binding StartingWeightText, Mode=TwoWay}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Secondary},
                                                              Dark={StaticResource Tertiary}}"
                            HorizontalTextAlignment="End"
                            Keyboard="Numeric"
                            VerticalTextAlignment="Center" />
                    </Frame>
                    <Label
                        Grid.Row="0" Grid.Column="2"
                        HorizontalTextAlignment="Start" VerticalTextAlignment="Center"
                        Text="{Binding StartingWeightUnits}" />
                </Grid>

                <!--  Plates one side only  -->
                <Grid
                    x:Name="OneSideOnlyGrid"
                    ColumnDefinitions="7*,3*"
                    ColumnSpacing="{x:Static graphics:PageLayout.Spacing}"
                    RowDefinitions="Auto">
                    <Label
                        Grid.Row="0" Grid.Column="0"
                        Text="Get plates for one side only"
                        VerticalTextAlignment="Center" />
                    <input:CheckBox
                        IsChecked="{Binding OneSideOnly, Mode=TwoWay}"
                        Grid.Row="0" Grid.Column="1"
                        HorizontalOptions="Start"
                        Type="Material" />
                </Grid>

                <!--  Calculate button  -->
                <Button Command="{Binding CalculateCommand}" Text="Calculate" />

                <!--  Error message  -->
                <Label Text="{Binding ErrorMessage}" Style="{StaticResource ErrorMessageStyle}">
                    <Label.Triggers>
                        <DataTrigger TargetType="Label" Binding="{Binding ErrorMessage}" Value="">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </Label.Triggers>
                </Label>
            </VerticalStackLayout>

            <!--
            Calculator results.
            Appears on bottom or right-hand side of page, depending on orientation.
            -->
            <VerticalStackLayout>
                <!-- Plates Results -->
                <CollectionView
                    ItemsSource="{Binding PlatesResults}"
                    IsVisible="{Binding PlatesResultsVisible}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:PlatesResult">
                            <Grid
                                Padding="0,10,0,10"
                                RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                                RowSpacing="{x:Static graphics:PageLayout.Spacing}"
                                ColumnDefinitions="4*,3*,3*"
                                ColumnSpacing="{x:Static graphics:PageLayout.Spacing}">
                                <Rectangle Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3"
                                    HeightRequest="1" BackgroundColor="Gray" />
                                <Label Grid.Row="1" Grid.Column="0"
                                    Text="{Binding Percent, StringFormat='{0}%'}"
                                    Style="{StaticResource ResultsTablePercent}" />
                                <Label Grid.Row="1" Grid.Column="1" Text="Ideal"
                                    VerticalTextAlignment="End"
                                    Style="{StaticResource ResultsTableHeader}" />
                                <Label Grid.Row="1" Grid.Column="2" Text="Closest"
                                    VerticalTextAlignment="End"
                                    Style="{StaticResource ResultsTableHeader}" />
                                <Label Grid.Row="2" Grid.Column="0" Text="Total"
                                    Style="{StaticResource ResultsTableHeader}" />
                                <Label Grid.Row="2" Grid.Column="1" Text="{Binding IdealTotal,
                                    Converter={StaticResource DefaultWeightTextConverter}}"
                                    Style="{StaticResource ResultsTableIdeal}" />
                                <Label Grid.Row="2" Grid.Column="2"
                                    Text="{Binding ClosestTotal,
                                        Converter={StaticResource DefaultWeightTextConverter}}"
                                    Style="{StaticResource ResultsTableClosest}" />
                                <Label Grid.Row="3" Grid.Column="0"
                                    Text="{Binding EachSideText}"
                                    Style="{StaticResource ResultsTableHeader}" />
                                <Label Grid.Row="3" Grid.Column="1"
                                    Text="{Binding IdealPlates,
                                        Converter={StaticResource DefaultWeightTextConverter}}"
                                    Style="{StaticResource ResultsTableIdeal}" />
                                <Label Grid.Row="3" Grid.Column="2"
                                    Text="{Binding ClosestPlates,
                                        Converter={StaticResource DefaultWeightTextConverter}}"
                                    Style="{StaticResource ResultsTableClosest}" />
                                <CollectionView Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="3"
                                    ItemsSource="{Binding PlateDrawables}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="drawables:PlateDrawable">
                                            <GraphicsView Drawable="{Binding .}"
                                                WidthRequest="{Binding Width}"
                                                HeightRequest="{Binding Height}"
                                                HorizontalOptions="Center" />
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Single Weight Results -->
                <CollectionView
                    ItemsSource="{Binding SingleWeightResults}"
                    IsVisible="{Binding SingleWeightResultsVisible}">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout ItemSpacing="10" Orientation="Vertical" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:SingleWeightResult">
                            <Frame
                                CornerRadius="8"
                                Padding="10"
                                Background="{AppThemeBinding Light={StaticResource Gray50},
                                Dark={StaticResource Gray900}}"
                                BorderColor="{AppThemeBinding Light={StaticResource Gray300},
                                Dark={StaticResource Gray600}}">
                                <Grid
                                    Padding="0,10,0,10"
                                    RowSpacing="{x:Static graphics:PageLayout.Spacing}"
                                    ColumnDefinitions="*,*,*"
                                    ColumnSpacing="{x:Static graphics:PageLayout.Spacing}"
                                    >
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="{Binding Drawable.Height}" />
                                    </Grid.RowDefinitions>
                                    <Label Grid.Row="0" Grid.Column="0"
                                        Text="{Binding Percent, StringFormat='{0}%'}"
                                        Style="{StaticResource ResultsTablePercent}" />
                                    <Label Grid.Row="0" Grid.Column="1" Text="Ideal"
                                        VerticalTextAlignment="End"
                                        Style="{StaticResource ResultsTableHeader}" />
                                    <Label Grid.Row="0" Grid.Column="2" Text="Closest"
                                        VerticalTextAlignment="End"
                                        Style="{StaticResource ResultsTableHeader}" />
                                    <Label Grid.Row="1" Grid.Column="0" Text="Total"
                                        Style="{StaticResource ResultsTableHeader}" />
                                    <Label Grid.Row="1" Grid.Column="1" Text="{Binding Ideal,
                                        Converter={StaticResource DefaultWeightTextConverter}}"
                                        Style="{StaticResource ResultsTableIdeal}" />
                                    <GraphicsView Grid.Row="1" Grid.Column="2"
                                        Drawable="{Binding Drawable}"
                                        WidthRequest="{Binding Drawable.Width}"
                                        HeightRequest="{Binding Drawable.Height}"
                                        HorizontalOptions="Center" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>

        </StackLayout>
    </ScrollView>
</ContentPage>
